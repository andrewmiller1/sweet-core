'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _sweetSpec = require('sweet-spec');

var S = _interopRequireWildcard(_sweetSpec);

var _ramda = require('ramda');

var _immutable = require('immutable');

var _terms = require('./terms');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

const notEmptyStatement = (0, _ramda.complement)(_terms.isEmptyStatement);

// $FlowFixMe: flow doesn't know about CloneReducer yet
exports.default = class extends S.default.CloneReducer {

  constructor(phase) {
    super();
    this.phase = phase;
  }

  reduceModule(t, s) {
    return new S.Module({
      directives: s.directives.filter(d => !d.startsWith('lang')).map(d => ({ type: 'Directive', rawValue: d })).toArray(),
      items: s.items.toArray().filter(notEmptyStatement)
    });
  }

  reduceIdentifierExpression(t, s) {
    return new S.IdentifierExpression({
      name: s.name.resolve(this.phase)
    });
  }

  reduceStaticPropertyName(t, s) {
    return new S.StaticPropertyName({
      value: s.value.val().toString()
    });
  }

  reduceBindingIdentifier(t, s) {
    return new S.BindingIdentifier({
      name: s.name.resolve(this.phase)
    });
  }

  reduceAssignmentTargetIdentifier(t, s) {
    return new S.AssignmentTargetIdentifier({
      name: s.name.resolve(this.phase)
    });
  }

  reduceStaticMemberExpression(t, s) {
    return new S.StaticMemberExpression({
      object: s.object,
      property: s.property.val()
    });
  }

  reduceStaticMemberAssignmentTarget(t, s) {
    return new S.StaticMemberAssignmentTarget({
      object: s.object,
      property: s.property.val()
    });
  }

  reduceFunctionBody(t, s) {
    return new S.FunctionBody({
      directives: s.directives.toArray(),
      statements: s.statements.toArray().filter(notEmptyStatement)
    });
  }

  reduceVariableDeclarationStatement(t, s) {
    if (t.declaration.kind === 'syntax' || t.declaration.kind === 'syntaxrec' || t.declaration.kind === 'operator') {
      return new S.EmptyStatement();
    }
    return new S.VariableDeclarationStatement({
      declaration: s.declaration
    });
  }

  reduceVariableDeclaration(t, s) {
    return new S.VariableDeclaration({
      kind: s.kind,
      declarators: s.declarators.toArray()
    });
  }

  reduceCallExpression(t, s) {
    return new S.CallExpression({
      callee: s.callee,
      arguments: s.arguments.toArray()
    });
  }

  reduceArrayExpression(t, s) {
    return new S.ArrayExpression({
      elements: s.elements.toArray()
    });
  }

  reduceImportNamespace(t, s) {
    if (s.forSyntax) {
      return new S.EmptyStatement();
    }
    return t;
  }

  reduceImport(t, s) {
    if (s.forSyntax) {
      return new S.EmptyStatement();
    }
    return new S.Import({
      forSyntax: false,
      defaultBinding: s.defaultBinding,
      moduleSpecifier: s.moduleSpecifier.val(),
      namedImports: s.namedImports.toArray()
    });
  }

  reduceBlock(t, s) {
    return new S.Block({
      statements: s.statements.toArray().filter(notEmptyStatement)
    });
  }

  reduceExportFromSpecifier(t, s) {
    return new S.ExportFromSpecifier({
      name: s.name.resolve(0),
      exportedName: s.exportedName == null ? null : s.exportedName.val()
    });
  }

  reduceExportLocalSpecifier(t, s) {
    return new S.ExportLocalSpecifier({
      name: s.name,
      exportedName: s.exportedName == null ? null : s.exportedName.val()
    });
  }

  reduceExportFrom(t, s) {
    return new S.ExportFrom({
      moduleSpecifier: s.moduleSpecifier != null ? s.moduleSpecifier.val() : null,
      namedExports: s.namedExports.toArray()
    });
  }

  reduceExportLocals(t, s) {
    return new S.ExportLocals({
      moduleSpecifier: s.moduleSpecifier != null ? s.moduleSpecifier.val() : null,
      namedExports: s.namedExports.toArray()
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zd2VldC10by1zaGlmdC1yZWR1Y2VyLmpzIl0sIm5hbWVzIjpbIlMiLCJub3RFbXB0eVN0YXRlbWVudCIsIkNsb25lUmVkdWNlciIsImNvbnN0cnVjdG9yIiwicGhhc2UiLCJyZWR1Y2VNb2R1bGUiLCJ0IiwicyIsIk1vZHVsZSIsImRpcmVjdGl2ZXMiLCJmaWx0ZXIiLCJkIiwic3RhcnRzV2l0aCIsIm1hcCIsInR5cGUiLCJyYXdWYWx1ZSIsInRvQXJyYXkiLCJpdGVtcyIsInJlZHVjZUlkZW50aWZpZXJFeHByZXNzaW9uIiwiSWRlbnRpZmllckV4cHJlc3Npb24iLCJuYW1lIiwicmVzb2x2ZSIsInJlZHVjZVN0YXRpY1Byb3BlcnR5TmFtZSIsIlN0YXRpY1Byb3BlcnR5TmFtZSIsInZhbHVlIiwidmFsIiwidG9TdHJpbmciLCJyZWR1Y2VCaW5kaW5nSWRlbnRpZmllciIsIkJpbmRpbmdJZGVudGlmaWVyIiwicmVkdWNlQXNzaWdubWVudFRhcmdldElkZW50aWZpZXIiLCJBc3NpZ25tZW50VGFyZ2V0SWRlbnRpZmllciIsInJlZHVjZVN0YXRpY01lbWJlckV4cHJlc3Npb24iLCJTdGF0aWNNZW1iZXJFeHByZXNzaW9uIiwib2JqZWN0IiwicHJvcGVydHkiLCJyZWR1Y2VTdGF0aWNNZW1iZXJBc3NpZ25tZW50VGFyZ2V0IiwiU3RhdGljTWVtYmVyQXNzaWdubWVudFRhcmdldCIsInJlZHVjZUZ1bmN0aW9uQm9keSIsIkZ1bmN0aW9uQm9keSIsInN0YXRlbWVudHMiLCJyZWR1Y2VWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50IiwiZGVjbGFyYXRpb24iLCJraW5kIiwiRW1wdHlTdGF0ZW1lbnQiLCJWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50IiwicmVkdWNlVmFyaWFibGVEZWNsYXJhdGlvbiIsIlZhcmlhYmxlRGVjbGFyYXRpb24iLCJkZWNsYXJhdG9ycyIsInJlZHVjZUNhbGxFeHByZXNzaW9uIiwiQ2FsbEV4cHJlc3Npb24iLCJjYWxsZWUiLCJhcmd1bWVudHMiLCJyZWR1Y2VBcnJheUV4cHJlc3Npb24iLCJBcnJheUV4cHJlc3Npb24iLCJlbGVtZW50cyIsInJlZHVjZUltcG9ydE5hbWVzcGFjZSIsImZvclN5bnRheCIsInJlZHVjZUltcG9ydCIsIkltcG9ydCIsImRlZmF1bHRCaW5kaW5nIiwibW9kdWxlU3BlY2lmaWVyIiwibmFtZWRJbXBvcnRzIiwicmVkdWNlQmxvY2siLCJCbG9jayIsInJlZHVjZUV4cG9ydEZyb21TcGVjaWZpZXIiLCJFeHBvcnRGcm9tU3BlY2lmaWVyIiwiZXhwb3J0ZWROYW1lIiwicmVkdWNlRXhwb3J0TG9jYWxTcGVjaWZpZXIiLCJFeHBvcnRMb2NhbFNwZWNpZmllciIsInJlZHVjZUV4cG9ydEZyb20iLCJFeHBvcnRGcm9tIiwibmFtZWRFeHBvcnRzIiwicmVkdWNlRXhwb3J0TG9jYWxzIiwiRXhwb3J0TG9jYWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQTs7SUFBa0JBLEM7O0FBQ2xCOztBQUNBOztBQUVBOzs7O0FBSUEsTUFBTUMsb0JBQW9CLCtDQUExQjs7QUFFQTtrQkFDZSxjQVhHRCxDQVdXLFNBQUtFLFlBQW5CLENBQWdDOztBQUc3Q0MsY0FBWUMsS0FBWixFQUEyQjtBQUN6QjtBQUNBLFNBQUtBLEtBQUwsR0FBYUEsS0FBYjtBQUNEOztBQUVEQyxlQUFhQyxDQUFiLEVBQXNCQyxDQUF0QixFQUF5RTtBQUN2RSxXQUFPLElBQUlQLEVBQUVRLE1BQU4sQ0FBYTtBQUNsQkMsa0JBQVlGLEVBQUVFLFVBQUYsQ0FDVEMsTUFEUyxDQUNGQyxLQUFLLENBQUNBLEVBQUVDLFVBQUYsQ0FBYSxNQUFiLENBREosRUFFVEMsR0FGUyxDQUVMRixNQUFNLEVBQUVHLE1BQU0sV0FBUixFQUFxQkMsVUFBVUosQ0FBL0IsRUFBTixDQUZLLEVBR1RLLE9BSFMsRUFETTtBQUtsQkMsYUFBT1YsRUFBRVUsS0FBRixDQUFRRCxPQUFSLEdBQWtCTixNQUFsQixDQUF5QlQsaUJBQXpCO0FBTFcsS0FBYixDQUFQO0FB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QVA7QUFJRDs7QUFFRDBDLDZCQUEyQjdELENBQTNCLEVBQW9DQyxDQUFwQyxFQUE2RTtBQUMzRSxXQUFPLElBQUlQLEVBQUVvRSxvQkFBTixDQUEyQjtBQUNoQ2hELFlBQU1iLEVBQUVhLElBRHdCO0FBRWhDOEMsb0JBQWMzRCxFQUFFMkQsWUFBRixJQUFrQixJQUFsQixHQUF5QixJQUF6QixHQUFnQzNELEVBQUUyRCxZQUFGLENBQWV6QyxHQUFmO0FBRmQsS0FBM0IsQ0FBUDtBQUlEOztBQUVENEMsbUJBQ0UvRCxDQURGLEVBRUVDLENBRkYsRUFHRTtBQUNBLFdBQU8sSUFBSVAsRUFBRXNFLFVBQU4sQ0FBaUI7QUFDdEJWLHVCQUNFckQsRUFBRXFELGVBQUYsSUFBcUIsSUFBckIsR0FBNEJyRCxFQUFFcUQsZUFBRixDQUFrQm5DLEdBQWxCLEVBQTVCLEdBQXNELElBRmxDO0FBR3RCOEMsb0JBQWNoRSxFQUFFZ0UsWUFBRixDQUFldkQsT0FBZjtBQUhRLEtBQWpCLENBQVA7QUFLRDs7QUFFRHdELHFCQUNFbEUsQ0FERixFQUVFQyxDQUZGLEVBR0U7QUFDQSxXQUFPLElBQUlQLEVBQUV5RSxZQUFOLENBQW1CO0FBQ3hCYix1QkFDRXJELEVBQUVxRCxlQUFGLElBQXFCLElBQXJCLEdBQTRCckQsRUFBRXFELGVBQUYsQ0FBa0JuQyxHQUFsQixFQUE1QixHQUFzRCxJQUZoQztBQUd4QjhDLG9CQUFjaEUsRUFBRWdFLFlBQUYsQ0FBZXZELE9BQWY7QUFIVSxLQUFuQixDQUFQO0FBS0Q7QUEvSzRDLEMiLCJmaWxlIjoic3dlZXQtdG8tc2hpZnQtcmVkdWNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5pbXBvcnQgVGVybSwgKiBhcyBTIGZyb20gJ3N3ZWV0LXNwZWMnO1xuaW1wb3J0IHsgY29tcGxlbWVudCB9IGZyb20gJ3JhbWRhJztcbmltcG9ydCB7IExpc3QgfSBmcm9tICdpbW11dGFibGUnO1xuXG5pbXBvcnQgeyBpc0VtcHR5U3RhdGVtZW50IH0gZnJvbSAnLi90ZXJtcyc7XG5cbmltcG9ydCB0eXBlIFN5bnRheCBmcm9tICcuL3N5bnRheC5qcyc7XG5cbmNvbnN0IG5vdEVtcHR5U3RhdGVtZW50ID0gY29tcGxlbWVudChpc0VtcHR5U3RhdGVtZW50KTtcblxuLy8gJEZsb3dGaXhNZTogZmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgQ2xvbmVSZWR1Y2VyIHlldFxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgZXh0ZW5kcyBUZXJtLkNsb25lUmVkdWNlciB7XG4gIHBoYXNlOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IocGhhc2U6IG51bWJlcikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5waGFzZSA9IHBoYXNlO1xuICB9XG5cbiAgcmVkdWNlTW9kdWxlKHQ6IFRlcm0sIHM6IHsgZGlyZWN0aXZlczogTGlzdDxzdHJpbmc+LCBpdGVtczogTGlzdDxhbnk+IH0pIHtcbiAgICByZXR1cm4gbmV3IFMuTW9kdWxlKHtcbiAgICAgIGRpcmVjdGl2ZXM6IHMuZGlyZWN0aXZlc1xuICAgICAgICAuZmlsdGVyKGQgPT4gIWQuc3RhcnRzV2l0aCgnbGFuZycpKVxuICAgICAgICAubWFwKGQgPT4gKHsgdHlwZTogJ0RpcmVjdGl2ZScsIHJhd1ZhbHVlOiBkIH0pKVxuICAgICAgICAudG9BcnJheSgpLFxuICAgICAgaXRlbXM6IHMuaXRlbXMudG9BcnJheSgpLmZpbHRlcihub3RFbXB0eVN0YXRlbWVudCksXG4gICAgfSk7XG4gIH1cblxuICByZWR1Y2VJZGVudGlmaWVyRXhwcmVzc2lvbih0OiBUZXJtLCBzOiB7IG5hbWU6IFN5bnRheCB9KSB7XG4gICAgcmV0dXJuIG5ldyBTLklkZW50aWZpZXJFeHByZXNzaW9uKHtcbiAgICAgIG5hbWU6IHMubmFtZS5yZXNvbHZlKHRoaXMucGhhc2UpLFxuICAgIH0pO1xuICB9XG5cbiAgcmVkdWNlU3RhdGljUHJvcGVydHlOYW1lKHQ6IFRlcm0sIHM6IHsgdmFsdWU6IFN5bnRheCB9KSB7XG4gICAgcmV0dXJuIG5ldyBTLlN0YXRpY1Byb3BlcnR5TmFtZSh7XG4gICAgICB2YWx1ZTogcy52YWx1ZS52YWwoKS50b1N0cmluZygpLFxuICAgIH0pO1xuICB9XG5cbiAgcmVkdWNlQmluZGluZ0lkZW50aWZpZXIodDogVGVybSwgczogeyBuYW1lOiBTeW50YXggfSkge1xuICAgIHJldHVybiBuZXcgUy5CaW5kaW5nSWRlbnRpZmllcih7XG4gICAgICBuYW1lOiBzLm5hbWUucmVzb2x2ZSh0aGlzLnBoYXNlKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlZHVjZUFzc2lnbm1lbnRUYXJnZXRJZGVudGlmaWVyKHQ6IFRlcm0sIHM6IHsgbmFtZTogU3ludGF4IH0pIHtcbiAgICByZXR1cm4gbmV3IFMuQXNzaWdubWVudFRhcmdldElkZW50aWZpZXIoe1xuICAgICAgbmFtZTogcy5uYW1lLnJlc29sdmUodGhpcy5waGFzZSksXG4gICAgfSk7XG4gIH1cblxuICByZWR1Y2VTdGF0aWNNZW1iZXJFeHByZXNzaW9uKHQ6IFRlcm0sIHM6IHsgb2JqZWN0OiBhbnksIHByb3BlcnR5OiBTeW50YXggfSkge1xuICAgIHJldHVybiBuZXcgUy5TdGF0aWNNZW1iZXJFeHByZXNzaW9uKHtcbiAgICAgIG9iamVjdDogcy5vYmplY3QsXG4gICAgICBwcm9wZXJ0eTogcy5wcm9wZXJ0eS52YWwoKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlZHVjZVN0YXRpY01lbWJlckFzc2lnbm1lbnRUYXJnZXQoXG4gICAgdDogVGVybSxcbiAgICBzOiB7IG9iamVjdDogYW55LCBwcm9wZXJ0eTogU3ludGF4IH0sXG4gICkge1xuICAgIHJldHVybiBuZXcgUy5TdGF0aWNNZW1iZXJBc3NpZ25tZW50VGFyZ2V0KHtcbiAgICAgIG9iamVjdDogcy5vYmplY3QsXG4gICAgICBwcm9wZXJ0eTogcy5wcm9wZXJ0eS52YWwoKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlZHVjZUZ1bmN0aW9uQm9keShcbiAgICB0OiBUZXJtLFxuICAgIHM6IHsgc3RhdGVtZW50czogTGlzdDxhbnk+LCBkaXJlY3RpdmVzOiBMaXN0PGFueT4gfSxcbiAgKSB7XG4gICAgcmV0dXJuIG5ldyBTLkZ1bmN0aW9uQm9keSh7XG4gICAgICBkaXJlY3RpdmVzOiBzLmRpcmVjdGl2ZXMudG9BcnJheSgpLFxuICAgICAgc3RhdGVtZW50czogcy5zdGF0ZW1lbnRzLnRvQXJyYXkoKS5maWx0ZXIobm90RW1wdHlTdGF0ZW1lbnQpLFxuICAgIH0pO1xuICB9XG5cbiAgcmVkdWNlVmFyaWFibGVEZWNsYXJhdGlvblN0YXRlbWVudCh0OiBhbnksIHM6IHsgZGVjbGFyYXRpb246IGFueSB9KSB7XG4gICAgaWYgKFxuICAgICAgdC5kZWNsYXJhdGlvbi5raW5kID09PSAnc3ludGF4JyB8fFxuICAgICAgdC5kZWNsYXJhdGlvbi5raW5kID09PSAnc3ludGF4cmVjJyB8fFxuICAgICAgdC5kZWNsYXJhdGlvbi5raW5kID09PSAnb3BlcmF0b3InXG4gICAgKSB7XG4gICAgICByZXR1cm4gbmV3IFMuRW1wdHlTdGF0ZW1lbnQoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBTLlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnQoe1xuICAgICAgZGVjbGFyYXRpb246IHMuZGVjbGFyYXRpb24sXG4gICAgfSk7XG4gIH1cblxuICByZWR1Y2VWYXJpYWJsZURlY2xhcmF0aW9uKHQ6IFRlcm0sIHM6IHsga2luZDogYW55LCBkZWNsYXJhdG9yczogTGlzdDxhbnk+IH0pIHtcbiAgICByZXR1cm4gbmV3IFMuVmFyaWFibGVEZWNsYXJhdGlvbih7XG4gICAgICBraW5kOiBzLmtpbmQsXG4gICAgICBkZWNsYXJhdG9yczogcy5kZWNsYXJhdG9ycy50b0FycmF5KCksXG4gICAgfSk7XG4gIH1cblxuICByZWR1Y2VDYWxsRXhwcmVzc2lvbih0OiBUZXJtLCBzOiB7IGNhbGxlZTogYW55LCBhcmd1bWVudHM6IExpc3Q8YW55PiB9KSB7XG4gICAgcmV0dXJuIG5ldyBTLkNhbGxFeHByZXNzaW9uKHtcbiAgICAgIGNhbGxlZTogcy5jYWxsZWUsXG4gICAgICBhcmd1bWVudHM6IHMuYXJndW1lbnRzLnRvQXJyYXkoKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlZHVjZUFycmF5RXhwcmVzc2lvbih0OiBUZXJtLCBzOiB7IGVsZW1lbnRzOiBMaXN0PGFueT4gfSkge1xuICAgIHJldHVybiBuZXcgUy5BcnJheUV4cHJlc3Npb24oe1xuICAgICAgZWxlbWVudHM6IHMuZWxlbWVudHMudG9BcnJheSgpLFxuICAgIH0pO1xuICB9XG5cbiAgcmVkdWNlSW1wb3J0TmFtZXNwYWNlKFxuICAgIHQ6IFRlcm0sXG4gICAgczoge1xuICAgICAgZGVmYXVsdEJpbmRpbmc6IFMuQmluZGluZ0lkZW50aWZpZXIsXG4gICAgICBtb2R1bGVTcGVjaWZpZXI6IFN5bnRheCxcbiAgICAgIG5hbWVzcGFjZUJpbmRpbmc6IFMuQmluZGluZ0lkZW50aWZpZXIsXG4gICAgfSxcbiAgKSB7XG4gICAgaWYgKHMuZm9yU3ludGF4KSB7XG4gICAgICByZXR1cm4gbmV3IFMuRW1wdHlTdGF0ZW1lbnQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHQ7XG4gIH1cblxuICByZWR1Y2VJbXBvcnQoXG4gICAgdDogVGVybSxcbiAgICBzOiB7XG4gICAgICBkZWZhdWx0QmluZGluZzogUy5CaW5kaW5nSWRlbnRpZmllcixcbiAgICAgIG1vZHVsZVNwZWNpZmllcjogU3ludGF4LFxuICAgICAgbmFtZWRJbXBvcnRzOiBMaXN0PGFueT4sXG4gICAgfSxcbiAgKSB7XG4gICAgaWYgKHMuZm9yU3ludGF4KSB7XG4gICAgICByZXR1cm4gbmV3IFMuRW1wdHlTdGF0ZW1lbnQoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBTLkltcG9ydCh7XG4gICAgICBmb3JTeW50YXg6IGZhbHNlLFxuICAgICAgZGVmYXVsdEJpbmRpbmc6IHMuZGVmYXVsdEJpbmRpbmcsXG4gICAgICBtb2R1bGVTcGVjaWZpZXI6IHMubW9kdWxlU3BlY2lmaWVyLnZhbCgpLFxuICAgICAgbmFtZWRJbXBvcnRzOiBzLm5hbWVkSW1wb3J0cy50b0FycmF5KCksXG4gICAgfSk7XG4gIH1cblxuICByZWR1Y2VCbG9jayh0OiBUZXJtLCBzOiB7IHN0YXRlbWVudHM6IExpc3Q8YW55PiB9KSB7XG4gICAgcmV0dXJuIG5ldyBTLkJsb2NrKHtcbiAgICAgIHN0YXRlbWVudHM6IHMuc3RhdGVtZW50cy50b0FycmF5KCkuZmlsdGVyKG5vdEVtcHR5U3RhdGVtZW50KSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlZHVjZUV4cG9ydEZyb21TcGVjaWZpZXIodDogVGVybSwgczogeyBuYW1lOiBhbnksIGV4cG9ydGVkTmFtZT86IFN5bnRheCB9KSB7XG4gICAgcmV0dXJuIG5ldyBTLkV4cG9ydEZyb21TcGVjaWZpZXIoe1xuICAgICAgbmFtZTogcy5uYW1lLnJlc29sdmUoMCksXG4gICAgICBleHBvcnRlZE5hbWU6IHMuZXhwb3J0ZWROYW1lID09IG51bGwgPyBudWxsIDogcy5leHBvcnRlZE5hbWUudmFsKCksXG4gICAgfSk7XG4gIH1cblxuICByZWR1Y2VFeHBvcnRMb2NhbFNwZWNpZmllcih0OiBUZXJtLCBzOiB7IG5hbWU6IGFueSwgZXhwb3J0ZWROYW1lPzogU3ludGF4IH0pIHtcbiAgICByZXR1cm4gbmV3IFMuRXhwb3J0TG9jYWxTcGVjaWZpZXIoe1xuICAgICAgbmFtZTogcy5uYW1lLFxuICAgICAgZXhwb3J0ZWROYW1lOiBzLmV4cG9ydGVkTmFtZSA9PSBudWxsID8gbnVsbCA6IHMuZXhwb3J0ZWROYW1lLnZhbCgpLFxuICAgIH0pO1xuICB9XG5cbiAgcmVkdWNlRXhwb3J0RnJvbShcbiAgICB0OiBUZXJtLFxuICAgIHM6IHsgbW9kdWxlU3BlY2lmaWVyPzogU3ludGF4LCBuYW1lZEV4cG9ydHM6IExpc3Q8Uy5FeHBvcnRGcm9tU3BlY2lmaWVyPiB9LFxuICApIHtcbiAgICByZXR1cm4gbmV3IFMuRXhwb3J0RnJvbSh7XG4gICAgICBtb2R1bGVTcGVjaWZpZXI6XG4gICAgICAgIHMubW9kdWxlU3BlY2lmaWVyICE9IG51bGwgPyBzLm1vZHVsZVNwZWNpZmllci52YWwoKSA6IG51bGwsXG4gICAgICBuYW1lZEV4cG9ydHM6IHMubmFtZWRFeHBvcnRzLnRvQXJyYXkoKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJlZHVjZUV4cG9ydExvY2FscyhcbiAgICB0OiBUZXJtLFxuICAgIHM6IHsgbW9kdWxlU3BlY2lmaWVyPzogU3ludGF4LCBuYW1lZEV4cG9ydHM6IExpc3Q8Uy5FeHBvcnRMb2NhbFNwZWNpZmllcj4gfSxcbiAgKSB7XG4gICAgcmV0dXJuIG5ldyBTLkV4cG9ydExvY2Fscyh7XG4gICAgICBtb2R1bGVTcGVjaWZpZXI6XG4gICAgICAgIHMubW9kdWxlU3BlY2lmaWVyICE9IG51bGwgPyBzLm1vZHVsZVNwZWNpZmllci52YWwoKSA6IG51bGwsXG4gICAgICBuYW1lZEV4cG9ydHM6IHMubmFtZWRFeHBvcnRzLnRvQXJyYXkoKSxcbiAgICB9KTtcbiAgfVxufVxuIl19